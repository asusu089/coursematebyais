<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CourseMate · AI Course Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-card: #ffffff;
      --accent: #3b82f6;
      --accent-strong: #2563eb;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
      --radius-xl: 26px;
      --radius-full: 999px;
      --shadow-soft: 0 28px 80px rgba(15, 23, 42, 0.25);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", Roboto, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-main);
      color: var(--text-main);
      background:
        radial-gradient(circle at 10% 0, #dbeafe 0, #eff6ff 35%, #e0f2fe 65%, #dbeafe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      position: relative;
      overflow-y: auto; /* scrollable */
    }

    /* --- moving blurry blobs --- */
    .bg-blob {
      position: fixed;
      border-radius: 999px;
      filter: blur(90px);
      opacity: 0.9;
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: 0;
      transform: translate3d(0,0,0);
      animation: blobDrift 18s ease-in-out infinite alternate;
    }

    .bg-blob:nth-child(1) {
      width: 420px;
      height: 420px;
      background: radial-gradient(circle at 30% 20%, #60a5fa 0, #818cf8 40%, transparent 70%);
      top: -120px;
      left: -80px;
      animation-duration: 16s;
    }

    .bg-blob:nth-child(2) {
      width: 520px;
      height: 520px;
      background: radial-gradient(circle at 70% 80%, #38bdf8 0, #22d3ee 35%, transparent 70%);
      bottom: -160px;
      right: -120px;
      animation-duration: 20s;
      animation-delay: 1s;
    }

    .bg-blob:nth-child(3) {
      width: 360px;
      height: 360px;
      background: radial-gradient(circle at 40% 60%, #a5b4fc 0, #c4b5fd 35%, transparent 70%);
      top: 45%;
      left: 55%;
      transform: translate3d(-50%, -50%, 0);
      animation-duration: 14s;
      animation-delay: 0.5s;
    }

    @keyframes blobDrift {
      0% {
        transform: translate3d(-30px, 0, 0) scale(1);
      }
      25% {
        transform: translate3d(40px, -60px, 0) scale(1.08);
      }
      50% {
        transform: translate3d(80px, 20px, 0) scale(1.03);
      }
      75% {
        transform: translate3d(-50px, 40px, 0) scale(1.1);
      }
      100% {
        transform: translate3d(-80px, -30px, 0) scale(1.04);
      }
    }

    /* noise layer */
    .noise-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.35;
      mix-blend-mode: soft-light;
      z-index: 1;
      background-image:
        linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(148,163,184,0.12) 100%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.3' numOctaves='2' stitchTiles='noStitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.35'/%3E%3C/svg%3E");
      background-size: cover, 220px 220px;
      animation: noiseShift 8s linear infinite alternate;
    }

    @keyframes noiseShift {
      0% { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-40px,-30px,0); }
    }

    /* --- main shell --- */
    .shell {
      position: relative;
      z-index: 2;
      max-width: 960px;
      width: 100%;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(255,255,255,0.9) 0, rgba(241,245,249,0.9) 55%, rgba(255,255,255,0.9) 100%);
      backdrop-filter: blur(28px);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(191, 219, 254, 0.9);
      padding: 22px 24px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: conic-gradient(from 180deg, #38bdf8, #6366f1, #a855f7, #38bdf8);
      padding: 2px;
      box-shadow: 0 18px 40px rgba(59, 130, 246, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brand-logo-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: radial-gradient(circle at 30% 0%, #ffffff 0, #e5f0ff 55%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 17px;
      letter-spacing: 0.08em;
      color: #1d4ed8;
    }

    .brand-text-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .brand-text-sub {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
    }

    .header-copy {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }

    .header-title {
      font-size: 22px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-title span {
      background: linear-gradient(120deg, #2563eb, #38bdf8, #a855f7);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      max-width: 440px;
    }

    .header-tag {
      background: rgba(239, 246, 255, 0.9);
      border-radius: var(--radius-full);
      padding: 6px 11px;
      font-size: 11px;
      color: #1d4ed8;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #bfdbfe;
      box-shadow: 0 10px 28px rgba(191, 219, 254, 0.85);
    }

    .header-tag-dot {
      width: 9px;
      height: 9px;
      border-radius: var(--radius-full);
      background: radial-gradient(circle at 30% 0%, #22c55e 0, #16a34a 70%);
      box-shadow: 0 0 0 3px rgba(187, 247, 208, 0.9);
    }

    /* chat layout */
    .chat-layout {
      margin-top: 4px;
      display: grid;
      grid-template-rows: minmax(0, 1fr) auto;
      gap: 10px;
      border-radius: 22px;
      padding: 14px;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.96) 0, rgba(239,246,255,0.96) 60%, rgba(248,250,252,0.98) 100%);
      border: 1px solid rgba(209, 213, 219, 0.9);
      box-shadow: 0 16px 40px rgba(148, 163, 184, 0.35);
    }

    .chat-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chat-header-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .chat-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-status-pill {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      background: #ecfdf5;
      border: 1px solid #bbf7d0;
      color: #15803d;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .chat-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .chat-meta {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chat-meta-pill {
      padding: 3px 8px;
      border-radius: var(--radius-full);
      border: 1px solid #e5e7eb;
      background: rgba(255,255,255,0.9);
    }

    .chat-messages {
      margin-top: 8px;
      padding: 6px 4px 2px;
      overflow-y: auto;
      max-height: 380px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.8) transparent;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.8);
      border-radius: 999px;
    }

    .bubble-row {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      width: 100%;
    }

    .bubble-row.user {
      justify-content: flex-end;
    }

    .bubble-avatar {
      width: 22px;
      height: 22px;
      border-radius: var(--radius-full);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      flex-shrink: 0;
    }

    .bubble-avatar.assistant {
      background: linear-gradient(135deg, #bfdbfe, #60a5fa);
      color: #0f172a;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
    }

    .bubble-avatar.user {
      background: linear-gradient(135deg, #fed7aa, #fb923c);
      color: #7c2d12;
      box-shadow: 0 4px 10px rgba(248, 171, 88, 0.55);
    }

    .bubble-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .bubble-wrapper.user {
      align-items: flex-end;
    }

    .bubble {
      font-size: 12px;
      max-width: 82%;
      line-height: 1.45;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid;
      white-space: pre-wrap;
    }

    .bubble.assistant {
      background: #f3f4ff;
      border-color: #c7d2fe;
      color: #0f172a;
    }

    .bubble.user {
      background: linear-gradient(135deg, #60a5fa, #6366f1);
      border-color: #93c5fd;
      color: #eff6ff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .bubble.system {
      font-size: 11px;
      background: #e0f2fe;
      border-color: #bae6fd;
      color: #0f172a;
    }

    .bubble-meta {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .typing {
      display: inline-flex;
      gap: 3px;
      align-items: flex-end;
    }

    .typing-dot {
      width: 4px;
      height: 4px;
      border-radius: var(--radius-full);
      background: #9ca3af;
      animation: typing 1s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.6;
      }
      30% {
        transform: translateY(-3px);
        opacity: 1;
      }
    }

    /* input */
    .input-shell {
      margin-top: 4px;
      border-radius: 999px;
      padding: 2px;
      background: linear-gradient(120deg, rgba(191, 219, 254, 1), rgba(129, 140, 248, 0.95));
      box-shadow: 0 14px 34px rgba(59,130,246,0.55);
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out;
    }

    .input-shell-inner {
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: inherit;
      background: #ffffff;
      padding: 7px 10px 7px 12px;
    }

    .input-shell.focused {
      transform: translateY(-1px);
      box-shadow: 0 20px 44px rgba(59,130,246,0.75);
    }

    .input-prefix {
      font-size: 11px;
      color: var(--text-muted);
      padding: 3px 8px;
      border-radius: var(--radius-full);
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .input-main {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 12px;
      resize: none;
      line-height: 1.4;
      max-height: 80px;
    }

    .input-main::placeholder {
      color: #c4c9d4;
    }

    .input-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .send-btn {
      border-radius: var(--radius-full);
      width: 30px;
      height: 30px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: radial-gradient(circle at 0 0, #e0f2fe 0, #3b82f6 50%, #4f46e5 100%);
      color: #eff6ff;
      box-shadow:
        0 10px 24px rgba(59, 130, 246, 0.8),
        0 0 0 1px rgba(219, 234, 254, 0.9);
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out,
        filter 0.16s ease-out;
      font-size: 15px;
      flex-shrink: 0;
    }

    .send-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow:
        0 14px 32px rgba(59, 130, 246, 1),
        0 0 0 1px rgba(239, 246, 255, 1);
    }

    .send-btn:active {
      transform: translateY(0);
      box-shadow:
        0 8px 20px rgba(59, 130, 246, 0.8),
        0 0 0 1px rgba(219, 234, 254, 1);
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* wizard */
    .wizard-shell {
      margin-top: 6px;
      border-radius: 18px;
      padding: 8px 10px 8px 12px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(209,213,219,0.9);
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 10px 26px rgba(148,163,184,0.45);
    }

    .wizard-label {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .wizard-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      flex: 1;
    }

    .wizard-btn {
      border-radius: 999px;
      border: 1px solid #dbeafe;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      background: #eff6ff;
      color: #1e40af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(191,219,254,0.9);
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out,
        background 0.15s ease-out, border-color 0.15s ease-out;
    }

    .wizard-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(191,219,254,1);
    }

    .wizard-btn.selected {
      background: linear-gradient(120deg, #3b82f6, #6366f1);
      color: #eff6ff;
      border-color: #93c5fd;
      box-shadow: 0 10px 20px rgba(59,130,246,0.8);
    }

    .wizard-next {
      border-radius: 999px;
      width: 28px;
      height: 28px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: #eff6ff;
      box-shadow: 0 8px 20px rgba(59,130,246,0.85);
      font-size: 14px;
      flex-shrink: 0;
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out,
        filter 0.16s ease-out;
    }

    .wizard-next:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 12px 26px rgba(59,130,246,1);
    }

    .wizard-next:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    @media (max-width: 720px) {
      body {
        padding: 12px;
      }
      .card {
        padding: 18px 16px 16px;
      }
      .chat-messages {
        max-height: 340px;
      }
      .header-subtitle {
        max-width: none;
      }
      .wizard-shell {
        flex-direction: column;
        align-items: flex-start;
      }
      .wizard-next {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <!-- fast, intense moving blobs -->
  <div class="bg-blob"></div>
  <div class="bg-blob"></div>
  <div class="bg-blob"></div>
  <div class="noise-overlay"></div>

  <div class="shell">
    <div class="card">
      <header class="header">
        <div class="brand">
          <div class="brand-logo">
            <div class="brand-logo-inner">CM</div>
          </div>
          <div>
            <div class="brand-text-main">CourseMate</div>
            <div class="brand-text-sub">AI COURSE SCHEDULER</div>
          </div>
        </div>
        <div class="header-copy">
          <div class="header-title">
            Plan a <span>balanced semester</span>
          </div>
          <div class="header-subtitle">
            CourseMate asks about your major, year, remaining requirements, and preferences,
            then suggests 2–3 conflict-free schedules that respect credit limits.
          </div>
        </div>
        <div class="header-tag">
          <span class="header-tag-dot"></span>
          <span>Graduation-aware · n8n-powered</span>
        </div>
      </header>

      <section class="chat-layout">
        <div>
          <div class="chat-header-row">
            <div class="chat-header-main">
              <div class="chat-title">
                Chat with CourseMate
                <span class="chat-status-pill">
                  <span class="header-tag-dot"></span>
                  Online
                </span>
              </div>
              <div class="chat-subtitle">
                Tell me your situation and preferences — I’ll return schedule options and highlight conflicts.
              </div>
            </div>
            <div class="chat-meta">
              <div class="chat-meta-pill">Max 21 credits / semester</div>
              <div class="chat-meta-pill">202x-1 = Spring · 202x-2 = Fall</div>
            </div>
          </div>

          <!-- CHAT WINDOW -->
          <div id="chatMessages" class="chat-messages">
            <div class="bubble-row">
              <div class="bubble-avatar assistant">AI</div>
              <div class="bubble-wrapper">
                <div class="bubble assistant system">
I'm CourseMate, your Al course scheduler.

Tell me:
• Your major(s)/minor(s) and year  
• Which requirements you've already completed  
• Target semester (spring or fall)  
• Preferences (no 9AM, day off, max credits, etc.)

I'll check graduation requirements first, avoid time clashes, respect the 21-credit cap, and propose 2-3 balanced schedule options when possible.                </div>
                <div class="bubble-meta">CourseMate · System message</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SHINY INPUT BOX -->
        <form class="input-shell" id="chatForm">
          <div class="input-shell-inner">
            <span class="input-prefix">You</span>
            <textarea
              id="chatInput"
              class="input-main"
              rows="1"
              placeholder="Example: I'm a 2nd-year IID & CTM double major planning 2026-1. I still need one IID ME, one CTM MR - Technovation, and 2 UIC Seminars. Prefer no 9AMs, ≤18 credits, and a free Friday."
            ></textarea>
            <div class="input-actions">
              <button type="submit" class="send-btn" id="sendBtn" title="Send">
                ➤
              </button>
            </div>
          </div>
        </form>

        <!-- MAJOR/YEAR WIZARD -->
        <div class="wizard-shell" id="wizardShell">
          <div class="wizard-label" id="wizardLabel">Step 1 · Choose your year</div>
          <div class="wizard-buttons" id="wizardButtons"></div>
          <button type="button" class="wizard-next" id="wizardNextBtn" title="Next step">➜</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ------- CONFIG: your n8n webhook -------
    const N8N_WEBHOOK_URL =
      "https://n8n.n8nasusuhelper.me/webhook/afe38fda-9f37-4572-bb57-494adb235c34/chat";
    const N8N_ROUTE = "general";

    // ------- DOM -------
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const chatMessages = document.getElementById("chatMessages");
    const sendBtn = document.getElementById("sendBtn");

    const wizardShell = document.getElementById("wizardShell");
    const wizardButtonsEl = document.getElementById("wizardButtons");
    const wizardLabelEl = document.getElementById("wizardLabel");
    const wizardNextBtn = document.getElementById("wizardNextBtn");

    let isSending = false;

    // wizard state
    const MAJORS = ["IID", "CTM", "CDM"];
    const YEARS = ["1st", "2nd", "3rd", "4th"];

    const IID_COURSES = [
      "MEDIA COMMUNICATION",
      "CULTURE AND DESIGN TRENDS",
      "DESIGN BUSINESS",
      "IT FOUNDATION",
      "COMPUTER PROGRAMMING AND LITERACY",
      "INTRODUCTION TO INFORMATION AND INTERACTION DESIGN",
      "BASIC DRAWING 1",
      "BASIC DRAWING 2",
      "COLOR DESIGN",
      "INTRODUCTION TO DIGITAL TOOLS",
      "THEORIES AND PRACTICES OF PUBLIC ART",
      "INTRODUCTION TO SOCIAL COMPUTING",
      "CRITICAL STUDIES OF VISUAL IMAGES",
      "ILLUSTRATION: AN INTERDISCIPLINARY APPROACH",
      "VISUAL SYSTEM",
      "AI CONTENT CREATION: AI AGENTS AND LLMS",
      "HUMAN-AI INTERACTION",
      "SENIOR PROJECT 1",
      "SENIOR PROJECT 2",
      "IDEA VISUALIZATION",
      "DESIGN FOR SOCIAL INNOVATION",
      "DATA VISUALIZATION",
      "SERVICE DESIGN"
    ];

    const CTM_COURSES = [
      "DESIGN & CITY IN CULTURE",
      "INTRODUCTION TO MANAGEMENT",
      "IT FOUNDATION",
      "COMPUTER PROGRAMMING AND LITERACY",
      "INFORMATION SYSTEMS MANAGEMENT",
      "STRATEGY FOR CREATIVE TECHNOLOGY BUSINESS",
      "UX DESIGN AND STRATEGIC MANAGEMENT",
      "ENTREPRENEURIALLY MANAGING IN CREATIVE TECHNOLOGY INDUSTRIES",
      "DATA SCIENCE FOR BUSINESS",
      "FINANCIAL ACCOUNTING FOR TECHNOLOGY VENTURE FIRMS",
      "STATISTICS FOR BUSINESS AND SUSTAINABILITY",
      "CULTURE TECHNOLOGY",
      "PROJECT MANAGEMENT IN CREATIVE INDUSTRY",
      "ECONOMICS OF TECHNOLOGICAL INNOVATION",
      "TECHNOVATION: TECHNOLOGY AND INNOVATION MANAGEMENT",
      "OPERATIONS RESEARCH AND MANAGEMENT SCIENCE",
      "HUMAN RESOURCE MANAGEMENT FOR TECHNOLOGY BUSINESS",
      "TECHNO-ART CAPSTONE PROJECT",
      "ATTRACTING INVESTMENT FOR AN ENTREPRENEURIAL VENTURE",
      "SOCIAL NETWORK ANALYSIS",
      "STRATEGIC MARKETING IN CREATIVE INDUSTRY",
      "MANAGERIAL ACCOUNTING FOR TECHNOLOGY VENTURE FIRMS",
      "DIGITAL BUSINESS STRATEGY",
      "SERVICE SYSTEM MANAGEMENT",
      "TOOLS AND TECHNIQUES FOR TECHNOLOGY MANAGEMENT",
      "MUSIC INFORMATION RETRIEVAL",
      "MANAGERIAL ECONOMICS FOR TECHNOLOGY BUSINESS",
      "DATA MINING FOR TECHNOLOGY MANAGEMENT",
      "EMPIRICAL METHODS IN NATURAL LANGUAGE PROCESSING FOR TECHNOLOGY MANAGEMENT",
      "UNDERGRADUATE DIRECTED STUDY",
      "INTRODUCTION TO SOCIAL COMPUTING",
      "THEORY OF FINANCIAL ANALYSIS"
    ];

    const CDM_COURSES = [
      "INTRODUCTION TO CULTURE AND DESIGN MANAGEMENT",
      "CREATIVE THINKING AND VISUALIZATION",
      "DESIGN & CITY IN CULTURE",
      "CULTURE AND DESIGN TRENDS",
      "DESIGN 1: ELEMENTS AND ORGANIZATION",
      "HISTORY OF MODERN AND CONTEMPORARY DESIGN",
      "DIGITAL DESIGN",
      "ART THEORY AND VISUAL CULTURE",
      "SERVICE DESIGN",
      "DESIGN 3: DESIGN AND PROTOTYPING",
      "DESIGN PROJECT MANAGEMENT",
      "ART AND CULTURE MARKETING",
      "TYPOGRAPHY DESIGN",
      "FOUNDATIONS OF MARKETING",
      "STRATEGIC MARKETING",
      "ACADEMIC-INDUSTRY PROJECT",
      "INTERDISCIPLINARY DESIGN MANAGEMENT",
      "SOCIAL INNOVATION AND SUSTAINABLE DEVELOPMENT",
      "TECHNO-ART CAPSTONE PROJECT",
      "DESIGN 2: DESIGN AND TECHNOLOGY",
      "CONTEMPORARY TOPICS IN CULTURAL INDUSTRY",
      "ORGANIZATION AND PLANNING OF EXHIBITION",
      "INTRODUCTION TO MARKETING",
      "CULTURE AND SERVICE DESIGN",
      "CUSTOMER EXPERIENCE (CX) AND MARKETING",
      "SOCIAL INNOVATION FOR SUSTAINABILITY",
      "BRAND MEDIA MANAGEMENT",
      "DESIGN TREND",
      "INTERACTION DESIGN",
      "DESIGN FOR SUSTAINABILITY",
      "INTRODUCTION TO SOCIAL COMPUTING"
    ];

    // steps: 0 = year, 1 = majors, 2 = courses, 3 = done
    let wizardStep = 0;
    let selectedMajors = new Set();
    let selectedYear = null;
    let selectedCourses = new Set();

    function scrollChatToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function humanJoin(list) {
      if (list.length === 0) return "";
      if (list.length === 1) return list[0];
      if (list.length === 2) return list[0] + " and " + list[1];
      return list.slice(0, -1).join(", ") + ", and " + list[list.length - 1];
    }

    // --- NEW: format assistant text (bold + line breaks) ---
    function formatAssistantText(text) {
      if (!text) return "";
      // basic escape to avoid injecting HTML
      let html = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      // **bold** -> <strong>bold</strong>
      html = html.replace(/\*\*(.+?)\*\*/gs, "<strong>$1</strong>");
      // new lines -> <br>
      html = html.replace(/\n/g, "<br>");
      return html;
    }

    function getChatId() {
      let chatId = sessionStorage.getItem("coursemate_chat_id");
      if (!chatId) {
        chatId = "chat_" + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem("coursemate_chat_id", chatId);
      }
      return chatId;
    }

    function createMessageBubble(role, text) {
      const row = document.createElement("div");
      row.className = "bubble-row" + (role === "user" ? " user" : "");

      const avatar = document.createElement("div");
      avatar.className = "bubble-avatar " + role;
      avatar.textContent = role === "user" ? "You" : "AI";

      const wrapper = document.createElement("div");
      wrapper.className = "bubble-wrapper" + (role === "user" ? " user" : "");

      const bubble = document.createElement("div");
      bubble.className = "bubble " + role;

      if (role === "assistant") {
        bubble.innerHTML = formatAssistantText(text);
      } else {
        bubble.textContent = text;
      }

      const meta = document.createElement("div");
      meta.className = "bubble-meta";
      meta.textContent =
        role === "user" ? "You" : "CourseMate · AI course scheduler";

      wrapper.appendChild(bubble);
      wrapper.appendChild(meta);

      if (role === "user") {
        row.appendChild(wrapper);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(wrapper);
      }

      chatMessages.appendChild(row);
      scrollChatToBottom();
      return bubble;
    }

    function showTypingIndicator() {
      const row = document.createElement("div");
      row.className = "bubble-row";

      const avatar = document.createElement("div");
      avatar.className = "bubble-avatar assistant";
      avatar.textContent = "AI";

      const wrapper = document.createElement("div");
      wrapper.className = "bubble-wrapper";
      wrapper.dataset.typing = "true";

      const bubble = document.createElement("div");
      bubble.className = "bubble assistant";

      const typing = document.createElement("div");
      typing.className = "typing";

      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("div");
        dot.className = "typing-dot";
        typing.appendChild(dot);
      }

      bubble.appendChild(typing);
      wrapper.appendChild(bubble);
      row.appendChild(avatar);
      row.appendChild(wrapper);

      chatMessages.appendChild(row);
      scrollChatToBottom();
      return row;
    }

    function removeTypingIndicator() {
      const typingWrapper = chatMessages.querySelector('[data-typing="true"]');
      if (typingWrapper && typingWrapper.parentElement) {
        typingWrapper.parentElement.remove();
      }
    }

    function setSendingState(active) {
      isSending = active;
      sendBtn.disabled = active;
      if (active) {
        chatInput.setAttribute("readonly", "readonly");
      } else {
        chatInput.removeAttribute("readonly");
      }
    }

    async function callN8n(messageText) {
      const chatId = getChatId();

      const res = await fetch(N8N_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chatId,
          message: messageText,
          route: N8N_ROUTE
        })
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error("n8n error:", errorText);
        throw new Error("Error from n8n webhook");
      }

      const data = await res.json();
      const reply =
        data.output ||
        data.reply ||
        data.result ||
        data.text ||
        JSON.stringify(data, null, 2);

      return reply;
    }

    async function handleUserMessage(text) {
      if (!text.trim() || isSending) return;
      const userText = text.trim();

      createMessageBubble("user", userText);

      showTypingIndicator();
      setSendingState(true);

      try {
        const assistantText = await callN8n(userText);
        removeTypingIndicator();
        const safeText =
          assistantText || "No reply received from CourseMate backend.";
        createMessageBubble("assistant", safeText);
      } catch (err) {
        console.error(err);
        removeTypingIndicator();
        createMessageBubble(
          "assistant",
          "⚠️ I couldn't reach the CourseMate n8n workflow. Check N8N_WEBHOOK_URL / route and try again."
        );
      } finally {
        setSendingState(false);
        scrollChatToBottom();
      }
    }

    // ------- wizard -------
    function renderWizard() {
      wizardButtonsEl.innerHTML = "";

      if (wizardStep === 0) {
        wizardLabelEl.textContent = "Step 1 · Choose your year";
        YEARS.forEach((year) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "wizard-btn" + (selectedYear === year ? " selected" : "");
          btn.textContent = year + " year";
          btn.addEventListener("click", () => {
            selectedYear = year;
            renderWizard();
            updateTextareaFromWizard();
          });
          wizardButtonsEl.appendChild(btn);
        });
        wizardNextBtn.disabled = !selectedYear;

      } else if (wizardStep === 1) {
        wizardLabelEl.textContent = "Step 2 · Choose your major(s)";
        MAJORS.forEach((major) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "wizard-btn" + (selectedMajors.has(major) ? " selected" : "");
          btn.textContent = major;
          btn.addEventListener("click", () => {
            if (selectedMajors.has(major)) {
              selectedMajors.delete(major);
            } else {
              selectedMajors.add(major);
            }
            renderWizard();
            updateTextareaFromWizard();
          });
          wizardButtonsEl.appendChild(btn);
        });
        wizardNextBtn.disabled = selectedMajors.size === 0;

      } else if (wizardStep === 2) {
        const hasIID = selectedMajors.has("IID");
        const hasCTM = selectedMajors.has("CTM");
        const hasCDM = selectedMajors.has("CDM");
        const majorsArr = Array.from(selectedMajors);

        let coursesToShow = [];
        let label = "Step 3 · Courses you have already taken";

        if (majorsArr.length === 1) {
          if (hasIID) {
            coursesToShow = IID_COURSES;
            label = "Step 3 · IID courses you have already taken";
          } else if (hasCTM) {
            coursesToShow = CTM_COURSES;
            label = "Step 3 · CTM courses you have already taken";
          } else if (hasCDM) {
            coursesToShow = CDM_COURSES;
            label = "Step 3 · CDM courses you have already taken";
          }
        } else if (majorsArr.length >= 2) {
          let combined = [];
          if (hasIID) combined = combined.concat(IID_COURSES);
          if (hasCTM) combined = combined.concat(CTM_COURSES);
          if (hasCDM) combined = combined.concat(CDM_COURSES);
          const seen = new Set();
          coursesToShow = combined.filter((c) => {
            if (seen.has(c)) return false;
            seen.add(c);
            return true;
          });
          label =
            "Step 3 · Courses you have already taken (all selected majors)";
        }

        wizardLabelEl.textContent = label;

        coursesToShow.forEach((course) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "wizard-btn" + (selectedCourses.has(course) ? " selected" : "");
          btn.textContent = course;
          btn.addEventListener("click", () => {
            if (selectedCourses.has(course)) {
              selectedCourses.delete(course);
            } else {
              selectedCourses.add(course);
            }
            renderWizard();
            updateTextareaFromWizard();
          });
          wizardButtonsEl.appendChild(btn);
        });

        wizardNextBtn.disabled = false;

      } else {
        wizardLabelEl.textContent = "Intro ready · you can edit and send";
        wizardButtonsEl.innerHTML = "";
        wizardNextBtn.disabled = true;
      }
    }

    function updateTextareaFromWizard() {
      const majorsArr = Array.from(selectedMajors);
      const majorsPhrase = humanJoin(majorsArr);
      let text = "";

      if (selectedYear && majorsPhrase) {
        text = `I am a ${selectedYear} year student majoring in ${majorsPhrase}. `;
      } else if (selectedYear) {
        text = `I am a ${selectedYear} year student. `;
      }

      const allCourses = Array.from(selectedCourses);
      if (allCourses.length > 0) {
        const coursesList = allCourses.join(", ");
        text += `i have taken ${coursesList} courses.`;
      }

      if (!text) return;

      chatInput.value = text;
      chatInput.style.height = "auto";
      chatInput.style.height = chatInput.scrollHeight + "px";
    }

    // ------- events -------
    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = chatInput.value;
      chatInput.value = "";
      chatInput.style.height = "auto";
      handleUserMessage(text);
    });

    chatInput.addEventListener("focus", () => {
      chatForm.classList.add("focused");
    });

    chatInput.addEventListener("blur", () => {
      chatForm.classList.remove("focused");
    });

    chatInput.addEventListener("input", () => {
      chatInput.style.height = "auto";
      chatInput.style.height = chatInput.scrollHeight + "px";
    });

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event("submit", { cancelable: true }));
      }
    });

    wizardNextBtn.addEventListener("click", () => {
      if (wizardStep === 0) {
        if (!selectedYear) return;
        wizardStep = 1;
        renderWizard();
        updateTextareaFromWizard();
      } else if (wizardStep === 1) {
        if (selectedMajors.size === 0) return;
        wizardStep = 2;
        renderWizard();
        updateTextareaFromWizard();
      } else if (wizardStep === 2) {
        wizardStep = 3;
        renderWizard();
        updateTextareaFromWizard();
      }
    });

    // initial wizard render
    renderWizard();
  </script>
</body>
</html>
